{% extends "layout.html" %}
{% block title %}Editar Proyecto{% endblock %}
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/perfil.css') }}">
{% endblock %}
{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">Editar Proyecto</h1>
    <div class="card shadow-sm mx-auto" style="max-width: 600px;" id="proyecto-editar-container">
        <!-- Formulario para editar el proyecto se genera din√°micamente -->
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
// ‚úÖ SCRIPT UNIFICADO PARA ACTUALIZAR EL INDICADOR DE NIVEL DE SEGURIDAD
function updateSecurityLevel() {
    const maxVulnInput = document.getElementById('max_vulnerabilidades');
    const maxSevInput = document.getElementById('max_severidad');
    const maxGradoInput = document.getElementById('max_grado_combinado'); // ‚úÖ NUEVO
    const securityIndicator = document.getElementById('security-level-indicator');
    const securityText = document.getElementById('security-level-text');
    const severityDisplay = document.getElementById('severity-display');
    const quantityDisplay = document.getElementById('quantity-display');
    const gradeDisplay = document.getElementById('grade-display'); // ‚úÖ NUEVO

    if (!maxVulnInput || !securityIndicator || !securityText) return;

    const vulnValue = parseInt(maxVulnInput.value) || 0;
    const sevValue = maxSevInput ? maxSevInput.value : 'MEDIUM';
    const gradeValue = parseInt(maxGradoInput?.value) || 50; // ‚úÖ NUEVO (con ?. para evitar errores)
    
    // Actualizar displays si existen
    if (quantityDisplay) {
        quantityDisplay.textContent = vulnValue;
    }
    
    // ‚úÖ ACTUALIZAR DISPLAY DEL GRADO COMBINADO
    if (gradeDisplay) {
        gradeDisplay.textContent = gradeValue;
    }
    
    if (severityDisplay) {
        const severityMap = {
            'LOW': 'üü¢ LOW',
            'MEDIUM': 'üü° MEDIUM', 
            'HIGH': 'üü† HIGH',
            'CRITICAL': 'üî¥ CRITICAL'
        };
        severityDisplay.textContent = severityMap[sevValue] || 'üü° MEDIUM';
    }
    
    // Remover clases anteriores
    securityIndicator.className = 'security-level';
    
    // ‚úÖ DETERMINAR NIVEL DE SEGURIDAD COMBINADO (incluyendo grado)
    const isRestrictiveSeverity = ['LOW', 'MEDIUM'].includes(sevValue);
    const isLowQuantity = vulnValue <= 5;
    const isMediumQuantity = vulnValue <= 15;
    const isLowGrade = gradeValue <= 30; // ‚úÖ NUEVO
    const isMediumGrade = gradeValue <= 70; // ‚úÖ NUEVO
    
    // ‚úÖ NUEVA L√ìGICA: Considerar los 3 factores
    if (isLowQuantity && isRestrictiveSeverity && isLowGrade) {
        securityIndicator.classList.add('high');
        securityText.innerHTML = '<i class="fas fa-shield-alt me-1"></i>Alta Seguridad';
    } else if (isMediumQuantity && (isRestrictiveSeverity || sevValue === 'HIGH') && isMediumGrade) {
        securityIndicator.classList.add('medium');
        securityText.innerHTML = '<i class="fas fa-shield-halved me-1"></i>Seguridad Est√°ndar';
    } else {
        securityIndicator.classList.add('low');
        securityText.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Seguridad B√°sica';
    }
}

// ‚úÖ FUNCI√ìN GLOBAL PARA PESOS (EDICI√ìN)
window.updatePesoDisplay = function() {
    const pesoSevInput = document.getElementById('peso_severidad');
    const pesoSolInput = document.getElementById('peso_solucionabilidad');
    
    if (!pesoSevInput || !pesoSolInput) return;
    
    const pesoSev = pesoSevInput.value;
    const pesoSol = pesoSolInput.value;
    
    // Actualizar displays
    const pesoSevDisplay = document.getElementById('peso-severidad-display');
    const pesoSolDisplay = document.getElementById('peso-solucionabilidad-display');
    
    if (pesoSevDisplay) pesoSevDisplay.textContent = pesoSev;
    if (pesoSolDisplay) pesoSolDisplay.textContent = pesoSol;
    
    // Actualizar preview
    const previewSev = document.getElementById('preview-peso-sev');
    const previewSol = document.getElementById('preview-peso-sol');
    
    if (previewSev) previewSev.textContent = pesoSev;
    if (previewSol) previewSol.textContent = pesoSol;
    
    // Auto-ajustar para que sumen 100%
    const total = parseInt(pesoSev) + parseInt(pesoSol);
    if (total !== 100 && event && event.target) {
        const diff = 100 - total;
        const currentTarget = event.target.id;
        const otherSlider = currentTarget === 'peso_severidad' ? 
                        document.getElementById('peso_solucionabilidad') : 
                        document.getElementById('peso_severidad');
        
        if (otherSlider) {
            const newValue = Math.max(0, Math.min(100, parseInt(otherSlider.value) + diff));
            otherSlider.value = newValue;
            
            // Actualizar displays despu√©s del ajuste
            setTimeout(window.updatePesoDisplay, 10);
        }
    }
}

// ‚úÖ FUNCI√ìN PARA UMBRALES (EDICI√ìN)
function updateUmbralDisplay() {
    const umbralFacilInput = document.getElementById('umbral_facil');
    const umbralMedioInput = document.getElementById('umbral_media');
    
    if (!umbralFacilInput || !umbralMedioInput) return;
    
    const umbralFacil = umbralFacilInput.value;
    const umbralMedio = umbralMedioInput.value;
    
    // Actualizar preview
    const previewFacil = document.getElementById('preview-umbral-facil');
    const previewFacil2 = document.getElementById('preview-umbral-facil-2');
    const previewMedio = document.getElementById('preview-umbral-medio');
    const previewMedio2 = document.getElementById('preview-umbral-medio-2');
    
    if (previewFacil) previewFacil.textContent = umbralFacil;
    if (previewFacil2) previewFacil2.textContent = umbralFacil - 1;
    if (previewMedio) previewMedio.textContent = umbralMedio;
    if (previewMedio2) previewMedio2.textContent = umbralMedio;
}

// ‚úÖ FUNCI√ìN PARA CONFIGURAR EVENT LISTENERS DIN√ÅMICOS
function setupDynamicEventListeners() {
    const maxVulnInput = document.getElementById('max_vulnerabilidades');
    const maxSevInput = document.getElementById('max_severidad');
    const maxGradoInput = document.getElementById('max_grado_combinado'); // ‚úÖ NUEVO
    const pesoSevInput = document.getElementById('peso_severidad');
    const pesoSolInput = document.getElementById('peso_solucionabilidad');
    const umbralFacilInput = document.getElementById('umbral_facil');
    const umbralMedioInput = document.getElementById('umbral_media');
    
    // Event listeners para seguridad
    if (maxVulnInput) {
        maxVulnInput.addEventListener('input', updateSecurityLevel);
    }
    if (maxSevInput) {
        maxSevInput.addEventListener('change', updateSecurityLevel);
    }
    
    // ‚úÖ EVENT LISTENER PARA GRADO COMBINADO
    if (maxGradoInput) {
        maxGradoInput.addEventListener('input', updateSecurityLevel);
        console.log("‚úÖ Event listener para grado combinado configurado");
    }
    
    // Event listeners para pesos
    if (pesoSevInput) {
        pesoSevInput.addEventListener('input', window.updatePesoDisplay);
    }
    if (pesoSolInput) {
        pesoSolInput.addEventListener('input', window.updatePesoDisplay);
    }
    
    // Event listeners para umbrales
    if (umbralFacilInput) {
        umbralFacilInput.addEventListener('input', updateUmbralDisplay);
    }
    if (umbralMedioInput) {
        umbralMedioInput.addEventListener('input', updateUmbralDisplay);
    }
    
    // Actualizar displays iniciales
    updateSecurityLevel();
    window.updatePesoDisplay();
    updateUmbralDisplay();
    
    console.log("‚úÖ Todos los event listeners configurados correctamente");
}

// Aplicar cuando se cargue din√°micamente el formulario
document.addEventListener('DOMContentLoaded', function() {
    // Observer para detectar cuando se a√±ade el formulario
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                const maxVulnInput = document.getElementById('max_vulnerabilidades');
                
                if (maxVulnInput) {
                    console.log("üîÑ Formulario de edici√≥n cargado din√°micamente");
                    
                    // ‚úÖ CONFIGURAR TODOS LOS EVENT LISTENERS
                    setupDynamicEventListeners();
                    
                    observer.disconnect(); // Dejar de observar
                }
            }
        });
    });
    
    observer.observe(document.getElementById('proyecto-editar-container'), {
        childList: true,
        subtree: true
    });
});
</script>
{% endblock %}